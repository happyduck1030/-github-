"use strict";const e=require("../../common/vendor.js"),o=require("../../utils/check.js"),t={components:{CustomModal:()=>"../../component/custom-modal/custom-modal.js"},data:()=>({latitude:21.15375,longitude:110.2965,scale:18,circles:[{id:1,latitude:21.15375,longitude:110.2965,radius:55,fillColor:"#00000011",color:"#74b9ff",strokeWidth:2}],showModal:!1,isOpen:getApp().globalData.isOP,inner:getApp().globalData.in}),methods:{showCustomModal(){this.showModal=!0},handleConfirm(e){o.register(e.name,e.className),this.showModal=!1},handleClose(){this.showModal=!1},toOpenDoor(){e.index.navigateTo({url:"/pages/openDoor/openDoor"})},subscribe(){""!=e.index.getStorageSync("token")?(e.index.getSetting({withSubscriptions:!0,success:e=>{console.log(e.authSetting),console.log(e.subscriptionsSetting)}}),e.index.showModal({content:"勾选“保持选择”后，每次打卡可接收下一次的开门通知。",cancelText:"取消",cancelColor:"red",confirmText:"我会勾选",confirmColor:"#409EFE",success:o=>{o.confirm?e.index.requestSubscribeMessage({tmplIds:["YT5WwUDkbE2OaixVEi8xPzwvvyCOQH7Q_SJSb3wGq-c"],complete:o=>{if(console.log(o),"accept"===o["YT5WwUDkbE2OaixVEi8xPzwvvyCOQH7Q_SJSb3wGq-c"]){console.log("isok");const o=e.index.getStorageSync("token");e.index.request({url:"https://turingteam.xyz:9642/subscribeMsg",method:"PUT",header:{Authorization:o},success:o=>{console.log(o),200===o.data.code&&e.index.showToast({title:o.data.msg})},fail:e=>{console.log(e)}})}}}):o.cancel&&console.log("用户点击取消")}})):this.showCustomModal()},scanCode(){if(""==e.index.getStorageSync("token"))return console.log("未登录"),void o.login(this.scanCode,this.showCustomModal);e.index.scanCode({onlyFromCamera:!0,success:o=>{"/"==o.path[0]?e.index.reLaunch({url:o.path}):e.index.reLaunch({url:"/"+o.path})}})},getLabStatus(){e.index.request({url:"https://turingteam.xyz:9642/getLabStatus",method:"GET",success:e=>{200===e.data.code&&(this.isOpen=e.data.data.status,getApp().globalData.isOP=e.data.data.status)},fail:e=>{console.log(e)}})},getPersonalLocation(o){e.index.getLocation({type:"gcj02",success:e=>{let o=e.latitude,t=e.longitude,a=this.caldistance(o,t);this.inner=a,getApp().globalData.in=a},fail:function(e){console.log("定位失败"),console.log(e)}})},caldistance(e,o,t=this.circles[0].latitude,a=this.circles[0].longitude){if(null==e)return!1;getApp().globalData.lat=e,getApp().globalData.lon=o;var s=e*Math.PI/180,n=t*Math.PI/180,i=s-n,l=o*Math.PI/180-a*Math.PI/180,c=2*Math.asin(Math.sqrt(Math.pow(Math.sin(i/2),2)+Math.cos(s)*Math.cos(n)*Math.pow(Math.sin(l/2),2)));return c*=6378.137,c=Math.round(1e4*c)/1e4,getApp().globalData.distance=1e3*c,1e3*c<=this.circles[0].radius}},onLoad(){e.index.clearStorage(),this.getLabStatus();""==e.index.getStorageSync("token")&&o.login2()},onShow(){this.getPersonalLocation(),this.getLabStatus(),e.index.createMapContext("map").setCenterOffset({offset:[.5,.35]}),setInterval((()=>{this.getPersonalLocation()}),1500)},onShareAppMessage:()=>({title:"图灵实验室打卡",path:"/pages/index/index",imageUrl:"/static/images/turing.jpg",success(e){console.log(e),console.log("分享成功！")}})};if(!Array){(e.resolveComponent("uni-nav-bar")+e.resolveComponent("uni-notice-bar")+e.resolveComponent("CustomModal"))()}Math||((()=>"../../uni_modules/uni-nav-bar/components/uni-nav-bar/uni-nav-bar.js")+(()=>"../../uni_modules/uni-notice-bar/components/uni-notice-bar/uni-notice-bar.js"))();const a=e._export_sfc(t,[["render",function(o,t,a,s,n,i){return{a:e.o(((...e)=>i.subscribe&&i.subscribe(...e))),b:e.p({fixed:!0,"status-bar":!0,border:!1,leftWidth:"140rpx"}),c:e.o(i.toOpenDoor),d:e.p({single:!0,color:n.isOpen?"#00917c":"#fff","background-color":n.isOpen?"#caf7e3":"red",text:n.isOpen?"实验室已开门，点此修正开门状态":"暂未开门，请在群里询问或点此修正开门状态","right-icon":"forward"}),e:e.t(n.inner?"打卡":"未进入范围"),f:e.o(((...e)=>i.scanCode&&i.scanCode(...e))),g:!n.inner,h:e.o(i.handleConfirm),i:e.o(i.handleClose),j:n.showModal,k:n.latitude,l:n.longitude,m:n.scale,n:n.circles}}]]);t.__runtimeHooks=2,wx.createPage(a);
